# Orb Version 1.2.0

version: 2.1
description: Publish NPM packages and canary deployments with Intuit's Auto

orbs:
  yarn: artsy/yarn@4.0.0
  node: artsy/node@0.1.0
  auto: auto/release@0.1.0

jobs:
  # Publishes a package to NPM
  publish:
    executor: node/build
    environment:
      AUTO_VERSION: v9.27.2
    parameters:
      version:
        type: string
        default: v9.27.2
      args:
        type: string
        default: ""
    steps:
      - yarn/pre-release
      - auto/shipit

  # Publishes a canary package to npm
  publish-canary:
    executor: node/build
    environment:
      AUTO_VERSION: v9.27.2
    parameters:
      version:
        type: string
        default: v9.27.2
      args:
        type: string
        default: ""
    steps:
      - run:
          name: Don't deploy canary if it's not a PR or if it's a fork
          command: |
            if [ -z "$CIRCLE_PULL_REQUEST" ]; then
              echo "Skipping, only deploys canaries on PR builds"
              circleci-agent step halt
            fi

            if [ -n "$CIRCLE_PR_NUMBER" ]; then
              echo "Skipping, can't deploy canaries for forks due to permissions issues."
              circleci-agent step halt
            fi
      - yarn/pre-release
      - auto/canary
